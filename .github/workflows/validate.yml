name: Validate Content

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  # Allow manual trigger
  workflow_dispatch:
  # Weekly content freshness check
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC

jobs:
  # PARANOID PRE-CHECK: Catch build-breaking errors BEFORE everything else
  # These are fast checks that catch common MDX/JSX issues that would fail the build
  pre-check:
    name: Pre-Build Syntax Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Check for unescaped comparison operators
        working-directory: apps/longterm
        run: |
          echo "Checking for unescaped < and > that will break JSX parsing..."
          node scripts/validate/validate-comparison-operators.mjs

      - name: Check for unescaped dollar signs
        working-directory: apps/longterm
        run: |
          echo "Checking for unescaped $ that will break LaTeX..."
          node scripts/validate/validate-dollar-signs.mjs

      - name: Check for tilde-dollar rendering issues
        working-directory: apps/longterm
        run: |
          echo "Checking for ~\\$ patterns that render incorrectly..."
          node scripts/validate/validate-tilde-dollar.mjs

      - name: Compile MDX files (catch JSX errors)
        working-directory: apps/longterm
        run: |
          echo "Attempting to compile all MDX files..."
          node scripts/validate/validate-mdx-compile.mjs --ci

  validate:
    name: Run Validation Checks
    runs-on: ubuntu-latest
    needs: pre-check  # Only run full validation if pre-check passes

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build data
        run: pnpm --filter longterm build:data

      - name: Run tests
        run: pnpm --filter longterm test

      - name: Run all validations
        id: validate
        working-directory: apps/longterm
        run: |
          # Skip mdx-compile (already ran in pre-check) and component-refs (has pre-existing issues)
          node scripts/validate/validate-all.mjs --ci --skip=mdx-compile,component-refs > ../../validation-results.json 2>&1 || true

          # Parse results for summary
          cat ../../validation-results.json

          # Check if any checks failed
          FAILED=$(node -e "const r = require('../../validation-results.json'); console.log(r.summary.failed)")

          if [ "$FAILED" != "0" ]; then
            echo "::error::$FAILED validation check(s) failed"
            exit 1
          fi

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: validation-results.json
          retention-days: 7

      - name: Create job summary
        if: always()
        run: |
          echo "## Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f validation-results.json ]; then
            node -e "
              const r = require('./validation-results.json');
              console.log('| Check | Status |');
              console.log('|-------|--------|');
              for (const c of r.checks) {
                const status = c.skipped ? 'âŠ˜ Skipped' : (c.passed ? 'âœ… Passed' : 'âŒ Failed');
                console.log('| ' + c.name + ' | ' + status + ' |');
              }
              console.log('');
              console.log('**Duration:** ' + r.duration);
            " >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Validation script failed to produce results" >> $GITHUB_STEP_SUMMARY
          fi

  build:
    name: Build Site
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build site
        run: pnpm --filter longterm build

  # Scheduled content freshness report
  staleness-report:
    name: Content Freshness Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build data
        run: pnpm --filter longterm build:data

      - name: Check staleness
        id: staleness
        working-directory: apps/longterm
        run: |
          # Run staleness check and capture count
          OUTPUT=$(node scripts/validate/check-staleness.mjs 2>&1)
          echo "$OUTPUT"

          # Extract stale count (look for "X stale" pattern)
          STALE_COUNT=$(echo "$OUTPUT" | grep -oP '\d+(?= stale)' | head -1 || echo "0")
          echo "stale_count=$STALE_COUNT" >> $GITHUB_OUTPUT

      - name: Create issue for stale content
        if: steps.staleness.outputs.stale_count > 10
        uses: actions/github-script@v7
        with:
          script: |
            const staleCount = '${{ steps.staleness.outputs.stale_count }}';
            const title = `ðŸ“… Content Review: ${staleCount} pages need attention`;
            const body = `## Weekly Content Freshness Report

            **${staleCount} pages** are past their review threshold.

            ### Action Required
            Run \`npm run validate:staleness\` locally to see the full list.

            ### Quick Commands
            \`\`\`bash
            # See stale pages
            npm run validate:staleness

            # Update a page's lastEdited date
            # Edit frontmatter: lastEdited: "${new Date().toISOString().split('T')[0]}"
            \`\`\`

            _This issue was automatically created by the weekly content freshness check._
            `;

            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'content-freshness'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['content-freshness', 'automated']
              });
            }
