---
/**
 * Custom MarkdownContent that auto-injects PageStatus from frontmatter
 *
 * This overrides Starlight's default MarkdownContent to add the PageStatus
 * component at the top of content pages when quality/llmSummary/etc
 * are defined in frontmatter.
 *
 * Also auto-injects ScenarioRatings at the bottom for AI Transition Model pages.
 */
import '../../../node_modules/@astrojs/starlight/style/markdown.css';
import { PageStatus } from '../wiki/PageStatus';
import { ScenarioRatings } from '../wiki/ScenarioRatings';
import pagesData from '@data/pages.json';
import { getInsightsBySource } from '@data/insights-data';
import {
  detectPageType,
  isAITransitionModelPage,
  shouldShowPageStatus,
} from '@lib/page-types';

// Get frontmatter from the route context
const { entry } = Astro.locals.starlightRoute;
const frontmatter = entry?.data || {};

// Extract page ID from pathname to look up additional metadata
const pathParts = Astro.url.pathname.split('/').filter(Boolean);
const pageId = pathParts[pathParts.length - 1] || '';
const pageData = pagesData.find((p: any) => p.id === pageId);

// Get insights for this page - try both with and without trailing slash
const pathWithSlash = Astro.url.pathname.endsWith('/') ? Astro.url.pathname : Astro.url.pathname + '/';
const pathWithoutSlash = Astro.url.pathname.replace(/\/$/, '');
const pageInsights = [
  ...getInsightsBySource(pathWithSlash),
  ...getInsightsBySource(pathWithoutSlash),
].filter((v, i, a) => a.findIndex(t => t.id === v.id) === i); // Dedupe by id

// Use centralized page type detection
const pageType = detectPageType(Astro.url.pathname, frontmatter.pageType);
const hasEditorialMeta = !!(frontmatter.quality || frontmatter.llmSummary || frontmatter.todo || frontmatter.todos || frontmatter.importance);
const hasInsights = pageInsights.length > 0;
const showPageStatus = shouldShowPageStatus(pageType, hasEditorialMeta, hasInsights);

// Check if this is an AI Transition Model page with ratings
const isATMPage = isAITransitionModelPage(Astro.url.pathname);
const ratings = (frontmatter as any).ratings;
const hasRatings = ratings && (ratings.changeability !== undefined || ratings.xriskImpact !== undefined || ratings.trajectoryImpact !== undefined || ratings.uncertainty !== undefined);
const showRatings = isATMPage && hasRatings;
---

<div class="sl-markdown-content">
  {showPageStatus && (
    <PageStatus
      client:load
      quality={frontmatter.quality}
      importance={frontmatter.importance}
      llmSummary={frontmatter.llmSummary}
      lastEdited={frontmatter.lastEdited}
      todo={frontmatter.todo}
      todos={frontmatter.todos}
      wordCount={pageData?.wordCount}
      backlinkCount={pageData?.backlinkCount}
      metrics={pageData?.metrics}
      suggestedQuality={pageData?.suggestedQuality}
      insights={pageInsights}
      issues={{
        unconvertedLinkCount: pageData?.unconvertedLinkCount,
        redundancy: pageData?.redundancy,
      }}
      pageType={frontmatter.pageType}
      pathname={Astro.url.pathname}
      devOnly={true}
    />
  )}
  <slot />
  {showRatings && (
    <div class="ratings-section">
      <hr />
      <h2 id="ratings">Ratings</h2>
      <ScenarioRatings
        client:load
        changeability={ratings.changeability}
        xriskImpact={ratings.xriskImpact}
        trajectoryImpact={ratings.trajectoryImpact}
        uncertainty={ratings.uncertainty}
      />
    </div>
  )}
</div>
